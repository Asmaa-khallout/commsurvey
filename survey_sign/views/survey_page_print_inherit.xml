<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template inherit_id="survey.survey_page_print" id="survey_page_print_inherit" name="Survey: print page">

        <xpath expr="//t[@t-call='survey.question_simple_choice']" position="replace">
            <t t-call="survey_sign.question_simple_choice"/>

        </xpath>

    </template>

    <template id="question_simple_choice" name="Question: simple choice">
        <t t-set="answer_line" t-value="answer_lines.filtered(lambda line: line.suggested_answer_id)"/>
        <t t-set="comment_line" t-value="answer_lines.filtered(lambda line: line.value_char_box)"/>
        <div class="row o_survey_form_choice"
             t-att-data-name="question.id"
             data-question-type="simple_choice_radio">
            <t t-set="item_idx" t-value="0"/>
            <div t-attf-class="col-lg-12 d-flex flex-wrap">
                <t t-set="has_correct_answer"
                   t-value="scoring_display_correction and any(label.is_correct for label in question.suggested_answer_ids)"/>
                <ul>
                    <t t-foreach='question.suggested_answer_ids' t-as='label'>
                        <t t-set="item_idx" t-value="label_index"/>
                        <t t-set="answer_selected"
                           t-value="answer_line and answer_line.suggested_answer_id.id == label.id"/>
                        <t t-set="is_correct" t-value="label.answer_score > 0.0"/>

                        <!--Used for print mode with corrections -->
                        <t t-set="answer_class" t-if="not has_correct_answer" t-value="''"/>
                        <t t-set="answer_class" t-elif="is_correct" t-value="'bg-success'"/>
                        <t t-set="answer_class" t-elif="not is_correct" t-value="'bg-danger'"/>

                        <li t-if="answer_selected" t-att-for="str(question.id) + '_' + str(label.id)"
                            t-att-class="'mr-2 mb-2 py-1 px-3 rounded %s %s' % (answer_class, 'o_survey_selected' if answer_selected else '')">
                            <!--                        <t t-call="survey.survey_selection_key">-->
                            <!--                            <t t-set="selection_key_class" t-value="'position-relative o_survey_radio_btn float-left d-flex'"/>-->
                            <!--                        </t>-->
                            <span class="ml-2" t-field='label.value'
                                  t-if="answer_line and answer_line.suggested_answer_id.id == label.id"/>

                            <!--                        <input t-att-id="str(question.id) + '_' + str(label.id)" type="radio" t-att-value='label.id' class="o_survey_form_choice_item invisible position-absolute"-->
                            <!--                               t-att-name='question.id'-->
                            <!--                               t-att-checked="answer_line and answer_line.suggested_answer_id.id == label.id and 'checked' or None"-->
                            <!--                               t-att-data-selection-key="letters[item_idx] if useKeySelection else ''"/>-->
                            <!--                        <i class="fa fa-check-circle float-right mt-1 position-relative"></i>-->
                            <!--                        <i class="fa fa-circle-thin float-right mt-1 position-relative"></i>-->
                            <!--                        <t t-call="survey.question_suggested_value_image"/>-->
                        </li>
                    </t>
                </ul>
            </div>
            <!--            <div t-if='question.comments_allowed and question.comment_count_as_answer' class="js_comments col-lg-12" >-->
            <!--                <div class="d-flex flex-wrap">-->
            <!--                    <label t-att-class="'o_survey_choice_btn mr-2 py-1 px-3 rounded %s' % ('o_survey_selected' if comment_line else '')">-->
            <!--                        <t t-set="item_idx" t-value="item_idx + 1"/>-->
            <!--                        <t t-call="survey.survey_selection_key">-->
            <!--                            <t t-set="selection_key_class" t-value="'position-relative o_survey_radio_btn float-left d-flex'"/>-->
            <!--                        </t>-->
            <!--                        <input type="radio" class="o_survey_form_choice_item o_survey_js_form_other_comment invisible position-absolute" value="-1"-->
            <!--                               t-att-name='question.id'-->
            <!--                               t-att-checked="comment_line and 'checked' or None"-->
            <!--                               t-att-data-selection-key="letters[item_idx] if useKeySelection else ''"/>-->
            <!--                        <span class="ml-2" t-field="question.comments_message" />-->
            <!--                        <i class="fa fa-check-circle float-right mt-1 position-relative"></i>-->
            <!--                        <i class="fa fa-circle-thin float-right mt-1 position-relative"></i>-->
            <!--                    </label>-->
            <!--                </div>-->
            <!--                <div t-attf-class="o_survey_comment_container mt-3 py-0 px-1  #{'d-none' if not comment_line else ''}">-->
            <!--                    <textarea type="text" class="form-control o_survey_question_text_box bg-transparent text-dark rounded-0 p-0"-->
            <!--                              t-att-disabled="None if comment_line else 'disabled'"><t t-esc="comment_line.value_char_box if comment_line else ''"/></textarea>-->
            <!--                </div>-->
            <!--            </div>-->
            <!--            <div t-if='question.comments_allowed and not question.comment_count_as_answer' class="col-lg-12 o_survey_comment_container mx-1 mt-3 pl-3 pr-4">-->
            <!--                <textarea type="text" class="form-control o_survey_comment o_survey_question_text_box bg-transparent text-dark rounded-0 p-0"-->
            <!--                          t-att-placeholder="question.comments_message if not survey_form_readonly else ''"><t t-esc="comment_line.value_char_box if comment_line else ''"/></textarea>-->
            <!--            </div>-->
        </div>
    </template>


    <template inherit_id="survey.survey_page_print" id="survey_page_print_inherit">
        <xpath expr="//div[hasclass('o_survey_print')]" position="before">
            <div class="ribbon ribbon-top-right" t-if="answer.state_signature=='not_signe'"><span>Refusé</span></div>
            <div class="ribbon ribbon-top-right" t-if="answer.state_signature=='signe'"><span>Signé</span></div>
        </xpath>
        <xpath expr="//div[@role='form']" position="inside">
            <t t-if="survey.show_signature and answer.state_signature=='progress'">

                <div class="form-check">

                    <input type="checkbox" class="form-check-input print_checkbox" id="confirm_print"/>
                    <label class="form-check-label" for="confirm_print">J'accepte</label>
                    <div class="invalid-feedback">
        Vous devez accepter avant la signature.
      </div>
                </div>
                <div class="mt-5 print_part">
                    <a type="button" class="btn  btn-finish btn_sign mx-2 disabled" href="#">Signature</a>


                    <button type="button" class="btn  btn-finish-d btn_refu"
                            href="#">Refuser
                    </button>
                </div>
                <t t-call="survey_sign.signature_modal">
                    <t t-set="answer" t-value="answer"/>
                </t>
            </t>

        </xpath>
        <xpath expr="//div[@role='form']" position="after">

            <div class="float-end" t-if="survey.show_signature and answer.signature">
                <p>Signé par :
                    <span t-esc="answer.signed_by" class="fw-bold"/>
                </p>
                <img t-att-src="image_data_uri(answer.signature)"
                     style="max-height: 4cm; max-width: 30cm;
                                 "/>
            </div>
        </xpath>
    </template>


    <template id="signature_modal">
        <div id="open_signature_modal" class="modal fade" role="dialog">
            <div class="modal-dialog modal-md">
                <div class="modal-content mt-4">
                    <div class="modal-header shadow">

                        <h3 class="w-100 text-center">Signature</h3>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body wk_modal">

                        <t t-call="portal.signature_form">
                            <t t-set="call_url" t-value="'/sign/survey/%s/accept' %(answer.id)"/>
                            <t t-set="default_name" t-value="'%s' %(answer.user_input_line_ids[1].display_name)"/>
                        </t>

                    </div>
                </div>
            </div>
        </div>
        <div id="refu_signature_modal" class="modal fade" role="dialog">
            <div class="modal-dialog modal-md">
                <div class="modal-content mt-4">
                    <div class="modal-header shadow">

                        <h3 class="w-100 text-center">Motif de refus</h3>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body wk_modal">
                        <form method="POST" t-att-action="'/sign/survey/%s/refu' %(answer.id)">
                              <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>

                        <div class="form-group">
                            <textarea class="form-control"  rows="3" name="motif"></textarea>
                        </div>
                        <button type="submit" class="mt-2 btn btn-danger ">Envoyer</button>
                        </form>

                    </div>
                </div>
            </div>
        </div>
    </template>
</odoo>
